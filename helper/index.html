<!DOCTYPE html>
<meta charset="UTF-8" />
<html>
  <head>
    <style>
      canvas {
        border: 1px solid #d3d3d3;
        background-color: #f1f1f1;
      }
    </style>
  </head>

  <body onload="gameContext.start()">
    <script>
      var gameContext = {
        canvas: document.createElement("canvas"),
        start: function () {
          this.canvas.width = 1000;
          this.canvas.height = 500;
          this.context = this.canvas.getContext("2d");
          document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        },
        clear: function () {
          this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },
      };

      var connection = new WebSocket("ws://127.0.0.1:8080");
      connection.binaryType = "arraybuffer";
      connection.onmessage = (e) => {
        let data = e.data;
        let dv = new DataView(data);

        let position = {
          x: dv.getInt32(0),
          y: dv.getInt32(0),
        };

        // Clear previous render
        gameContext.clear();
        // Re-render with new state
        //state.forEach( e => {
        for (var i = 0; i < state.length; i++) {
          let e = state[i];
          console.log(position);
          ctx = gameContext.context;
          ctx.fillStyle = "red";
          ctx.fillRect(position.x, position.y, 100, 100);
        }
      };

      const PacketID = {
        MOVE_LEFT: 1,
        MOVE_RIGHT: 2,
        MOVE_UP: 3,
        MOVE_DOWN: 4,
      };

      document.addEventListener("keydown", function (event) {
        if (event.keyCode == 37) {
          let dv = new DataView();
          dv.setInt8(0, PacketID.MOVE_LEFT);
          connection.send(dv);
        } else if (event.keyCode == 39) {
          let dv = new DataView();
          dv.setInt8(0, PacketID.MOVE_RIGHT);
          connection.send(dv);
        } else if (event.keyCode == 38) {
          let dv = new DataView();
          dv.setInt8(0, PacketID.MOVE_UP);
          connection.send(dv);
        } else if (event.keyCode == 40) {
          let dv = new DataView();
          dv.setInt8(0, PacketID.MOVE_DOWN);
          connection.send(dv);
        }
      });
    </script>
  </body>
</html>
